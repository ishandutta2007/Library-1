name: Daily Gemini

on:
  schedule:
    - cron: '0 0 * * *' # æ¯æ—¥ 0:00 UTCï¼ˆJST 9:00ï¼‰
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  ai-code-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      # 1. ãƒªãƒã‚¸ãƒˆãƒªå–å¾—
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. æ—¥ä»˜ä»˜ããƒ–ãƒ©ãƒ³ãƒåã‚’ä½œæˆ
      - name: Set branch name
        id: vars
        run: echo "branch=ai/code-update-$(date +'%Y%m%d')" >> $GITHUB_OUTPUT

      # 3. Gemini CLI ã§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåˆ†æã¨æ”¹å–„ææ¡ˆã‚’å®Ÿè¡Œ
      - name: Run Gemini CLI for documentation analysis
        id: gemini
        uses: google-github-actions/run-gemini-cli@v0
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          prompt: |
            ã‚ãªãŸã¯ç«¶æŠ€ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ”¹å–„ã‚’è¡Œã†AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚
            ä»¥ä¸‹ã®ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š

            ## ã‚¿ã‚¹ã‚¯æ¦‚è¦
            1. `find md/ -name "*.md" | shuf -n 1` ã§ãƒ©ãƒ³ãƒ€ãƒ ã«.mdãƒ•ã‚¡ã‚¤ãƒ«ã‚’1ã¤é¸æŠ
            2. é¸æŠã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã¨å¯¾å¿œã™ã‚‹src/å†…ã®.hppãƒ•ã‚¡ã‚¤ãƒ«ã®å®Ÿè£…ã‚’ç¢ºèª
            3. test/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®é–¢é€£ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚‚å‚ç…§
            4. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ”¹å–„ææ¡ˆã‚’ä½œæˆ

            ## è©•ä¾¡ãƒ»æ”¹å–„è¦³ç‚¹
            - **æ­£ç¢ºæ€§**: ã‚³ãƒ¼ãƒ‰ä¾‹ãŒå®Ÿè£…ã¨ä¸€è‡´ã—ã¦ã„ã‚‹ã‹
            - **å®Œå…¨æ€§**: é‡è¦ãªæ©Ÿèƒ½ãƒ»åˆ¶ç´„ãƒ»è¨ˆç®—é‡ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã‹  
            - **å¯èª­æ€§**: ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³æ§‹æ–‡ãŒé©åˆ‡ã§ã€èª¬æ˜ãŒåˆ†ã‹ã‚Šã‚„ã™ã„ã‹
            - **ä¸€è²«æ€§**: ä»–ã®.mdãƒ•ã‚¡ã‚¤ãƒ«ã¨æ›¸å¼ãƒ»æ§‹æˆãŒçµ±ä¸€ã•ã‚Œã¦ã„ã‚‹ã‹

            ## å‡ºåŠ›å½¢å¼
            æ”¹å–„ãŒå¿…è¦ãªå ´åˆã®ã¿ã€ä»¥ä¸‹ã®å½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š

            ```
            IMPROVEMENT_NEEDED=true
            TARGET_FILE=[æ”¹å–„å¯¾è±¡ã®mdãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹]
            IMPROVEMENT_SUMMARY=[æ”¹å–„å†…å®¹ã®è¦ç´„ï¼ˆ1è¡Œï¼‰]
            PATCH=[unified diffå½¢å¼ã®ãƒ‘ãƒƒãƒ]
            ```

            æ”¹å–„ãŒä¸è¦ãªå ´åˆã¯ä»¥ä¸‹ã‚’å‡ºåŠ›ï¼š
            ```
            IMPROVEMENT_NEEDED=false
            ```

            ## æ³¨æ„äº‹é …
            - å®Ÿè£…ã‚³ãƒ¼ãƒ‰ã‚’æ­£ç¢ºã«ç†è§£ã—ã¦ã‹ã‚‰æ–‡æ›¸åŒ–ã™ã‚‹ã“ã¨
            - æ—¢å­˜ã®æ–‡æ›¸æ§‹é€ ãƒ»æ›¸å¼ã«åˆã‚ã›ã‚‹ã“ã¨
            - æ•°å¼ã‚„å›³è¡¨ãŒå¿…è¦ãªå ´åˆã¯é©åˆ‡ãªãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³è¨˜æ³•ã‚’ä½¿ç”¨
            - 1ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®æ”¹å–„ã«ç„¦ç‚¹ã‚’å½“ã¦ã‚‹ã“ã¨

      # 4. Geminiå‡ºåŠ›ã®è§£æ
      - name: Parse Gemini output
        id: parse
        run: |
          echo "${{ steps.gemini.outputs.response }}" > gemini_output.txt
          
          if grep -q "IMPROVEMENT_NEEDED=true" gemini_output.txt; then
            echo "needs_improvement=true" >> $GITHUB_OUTPUT
            
            # TARGET_FILEã‚’æŠ½å‡º
            target_file=$(grep "TARGET_FILE=" gemini_output.txt | cut -d'=' -f2)
            echo "target_file=$target_file" >> $GITHUB_OUTPUT
            
            # IMPROVEMENT_SUMMARYã‚’æŠ½å‡º
            summary=$(grep "IMPROVEMENT_SUMMARY=" gemini_output.txt | cut -d'=' -f2-)
            echo "summary=$summary" >> $GITHUB_OUTPUT
            
            # PATCHã‚’æŠ½å‡ºã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
            sed -n '/PATCH=/,/```/p' gemini_output.txt | sed '1d;$d' > improvement.patch
          else
            echo "needs_improvement=false" >> $GITHUB_OUTPUT
          fi

      # 5. ãƒ‘ãƒƒãƒã®é©ç”¨
      - name: Apply improvements
        if: steps.parse.outputs.needs_improvement == 'true'
        run: |
          if [ -f improvement.patch ] && [ -s improvement.patch ]; then
            echo "Applying patch..."
            git apply improvement.patch || echo "Patch application failed, but continuing..."
          fi

      # 6. PRä½œæˆï¼ˆæ”¹å–„ãŒå¿…è¦ãªå ´åˆã®ã¿ï¼‰
      - name: Create Pull Request
        if: steps.parse.outputs.needs_improvement == 'true'
        id: create_pr
        uses: peter-evans/create-pull-request@v6
        with:
          branch: ${{ steps.vars.outputs.branch }}
          commit-message: "ğŸ¤– AI: Improve documentation for ${{ steps.parse.outputs.target_file }}"
          title: "ğŸ¤– AI: Improve documentation for ${{ steps.parse.outputs.target_file }}"
          body: |
            ## ğŸ¤– AI-Generated Documentation Improvement

            ### æ”¹å–„å¯¾è±¡
            - `${{ steps.parse.outputs.target_file }}`

            ### æ”¹å–„å†…å®¹
            ${{ steps.parse.outputs.summary }}

            ### æ”¹å–„è¦³ç‚¹
            - âœ… æ­£ç¢ºæ€§: ã‚³ãƒ¼ãƒ‰ä¾‹ã¨å®Ÿè£…ã®ä¸€è‡´æ€§ç¢ºèª
            - âœ… å®Œå…¨æ€§: é‡è¦ãªæ©Ÿèƒ½ãƒ»åˆ¶ç´„ãƒ»è¨ˆç®—é‡ã®è¨˜è¼‰
            - âœ… å¯èª­æ€§: ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³æ§‹æ–‡ã¨èª¬æ˜ã®åˆ†ã‹ã‚Šã‚„ã™ã•
            - âœ… ä¸€è²«æ€§: ä»–ã®æ–‡æ›¸ã¨ã®æ›¸å¼ãƒ»æ§‹æˆã®çµ±ä¸€

            ### ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒã‚¤ãƒ³ãƒˆ
            - [ ] èª¬æ˜ã®åˆ†ã‹ã‚Šã‚„ã™ã•

            ---
            *Generated by Gemini CLI on $(date +'%Y-%m-%d')*
            
            @coderabbitai review
          delete-branch: true
          labels: |
            documentation
            ai-generated
            enhancement
