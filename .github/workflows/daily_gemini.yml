name: Daily Gemini

on:
  schedule:
    - cron: '0 0 * * *' # æ¯æ—¥ 0:00 UTCï¼ˆJST 9:00ï¼‰
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  ai-code-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      # 1. ãƒªãƒã‚¸ãƒˆãƒªå–å¾—
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. æ—¥ä»˜ä»˜ããƒ–ãƒ©ãƒ³ãƒåã‚’ä½œæˆ
      - name: Set branch name
        id: vars
        run: echo "branch=ai/code-update-$(date +'%Y%m%d')" >> $GITHUB_OUTPUT

      # 3. Gemini CLI ã§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåˆ†æã¨æ”¹å–„ææ¡ˆã‚’å®Ÿè¡Œ
      - name: Run Gemini CLI for documentation analysis
        id: gemini
        uses: google-github-actions/run-gemini-cli@v0
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          prompt: |
            ã‚ãªãŸã¯ç«¶æŠ€ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ”¹å–„ã‚’è¡Œã†AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚
            ä»¥ä¸‹ã®ã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š

            ## ã‚¿ã‚¹ã‚¯æ¦‚è¦
            1. `find md/ -name "*.md" | shuf -n 1` ã§ãƒ©ãƒ³ãƒ€ãƒ ã«.mdãƒ•ã‚¡ã‚¤ãƒ«ã‚’1ã¤é¸æŠ
            2. é¸æŠã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã¨å¯¾å¿œã™ã‚‹src/å†…ã®.hppãƒ•ã‚¡ã‚¤ãƒ«ã®å®Ÿè£…ã‚’ç¢ºèª
            3. test/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®é–¢é€£ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚‚å‚ç…§
            4. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ”¹å–„ææ¡ˆã‚’ä½œæˆ

            ## è©•ä¾¡ãƒ»æ”¹å–„è¦³ç‚¹
            - **æ­£ç¢ºæ€§**: ã‚³ãƒ¼ãƒ‰ä¾‹ãŒå®Ÿè£…ã¨ä¸€è‡´ã—ã¦ã„ã‚‹ã‹
            - **å®Œå…¨æ€§**: é‡è¦ãªæ©Ÿèƒ½ãƒ»åˆ¶ç´„ãƒ»è¨ˆç®—é‡ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã‹  
            - **å¯èª­æ€§**: ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³æ§‹æ–‡ãŒé©åˆ‡ã§ã€èª¬æ˜ãŒåˆ†ã‹ã‚Šã‚„ã™ã„ã‹
            - **ä¸€è²«æ€§**: ä»–ã®.mdãƒ•ã‚¡ã‚¤ãƒ«ã¨æ›¸å¼ãƒ»æ§‹æˆãŒçµ±ä¸€ã•ã‚Œã¦ã„ã‚‹ã‹

            ## å®Ÿè¡Œæ‰‹é †ã¨å‡ºåŠ›
            æ”¹å–„ãŒå¿…è¦ãªå ´åˆã¯ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š

            ```bash
            echo "IMPROVEMENT_NEEDED=true" >> $GITHUB_ENV
            echo "TARGET_FILE=[æ”¹å–„å¯¾è±¡ã®mdãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹]" >> $GITHUB_ENV
            echo "IMPROVEMENT_SUMMARY=[æ”¹å–„å†…å®¹ã®è¦ç´„ï¼ˆ1è¡Œï¼‰]" >> $GITHUB_ENV
            # ãƒ‘ãƒƒãƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
            cat > improvement.patch << 'EOF'
            [unified diffå½¢å¼ã®ãƒ‘ãƒƒãƒå†…å®¹]
            EOF
            ```

            æ”¹å–„ãŒä¸è¦ãªå ´åˆã¯ä»¥ä¸‹ã‚’å®Ÿè¡Œï¼š
            ```bash
            echo "IMPROVEMENT_NEEDED=false" >> $GITHUB_ENV
            ```

            ## æ³¨æ„äº‹é …
            - å®Ÿè£…ã‚³ãƒ¼ãƒ‰ã‚’æ­£ç¢ºã«ç†è§£ã—ã¦ã‹ã‚‰æ–‡æ›¸åŒ–ã™ã‚‹ã“ã¨
            - æ—¢å­˜ã®æ–‡æ›¸æ§‹é€ ãƒ»æ›¸å¼ã«åˆã‚ã›ã‚‹ã“ã¨
            - æ•°å¼ã‚„å›³è¡¨ãŒå¿…è¦ãªå ´åˆã¯é©åˆ‡ãªãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³è¨˜æ³•ã‚’ä½¿ç”¨
            - 1ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®æ”¹å–„ã«ç„¦ç‚¹ã‚’å½“ã¦ã‚‹ã“ã¨
            - å¿…ãšä¸Šè¨˜ã®bashã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¦ãã ã•ã„

      # 4. ç’°å¢ƒå¤‰æ•°ã‹ã‚‰æ”¹å–„æƒ…å ±ã‚’ç¢ºèª
      - name: Check improvement status
        id: check
        run: |
          echo "IMPROVEMENT_NEEDED value: $IMPROVEMENT_NEEDED"
          echo "TARGET_FILE value: $TARGET_FILE"
          echo "IMPROVEMENT_SUMMARY value: $IMPROVEMENT_SUMMARY"
          
          if [ "$IMPROVEMENT_NEEDED" = "true" ]; then
            echo "needs_improvement=true" >> $GITHUB_OUTPUT
            echo "target_file=$TARGET_FILE" >> $GITHUB_OUTPUT
            echo "summary=$IMPROVEMENT_SUMMARY" >> $GITHUB_OUTPUT
          else
            echo "needs_improvement=false" >> $GITHUB_OUTPUT
          fi

      # 5. ãƒ‘ãƒƒãƒã®é©ç”¨
      - name: Apply improvements
        if: env.IMPROVEMENT_NEEDED == 'true'
        run: |
          if [ -f improvement.patch ] && [ -s improvement.patch ]; then
            echo "Applying patch..."
            cat improvement.patch
            git apply improvement.patch || echo "Patch application failed, but continuing..."
          else
            echo "No patch file found or patch file is empty"
          fi

      # 6. PRä½œæˆï¼ˆæ”¹å–„ãŒå¿…è¦ãªå ´åˆã®ã¿ï¼‰
      - name: Create Pull Request
        if: env.IMPROVEMENT_NEEDED == 'true'
        id: create_pr
        uses: peter-evans/create-pull-request@v6
        with:
          branch: ${{ steps.vars.outputs.branch }}
          commit-message: "ğŸ¤– AI: Improve documentation for ${{ env.TARGET_FILE }}"
          title: "ğŸ¤– AI: Improve documentation for ${{ env.TARGET_FILE }}"
          body: |
            ## ğŸ¤– AI-Generated Documentation Improvement

            ### æ”¹å–„å¯¾è±¡
            - `${{ env.TARGET_FILE }}`

            ### æ”¹å–„å†…å®¹
            ${{ env.IMPROVEMENT_SUMMARY }}

            ### æ”¹å–„è¦³ç‚¹
            - âœ… æ­£ç¢ºæ€§: ã‚³ãƒ¼ãƒ‰ä¾‹ã¨å®Ÿè£…ã®ä¸€è‡´æ€§ç¢ºèª
            - âœ… å®Œå…¨æ€§: é‡è¦ãªæ©Ÿèƒ½ãƒ»åˆ¶ç´„ãƒ»è¨ˆç®—é‡ã®è¨˜è¼‰
            - âœ… å¯èª­æ€§: ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³æ§‹æ–‡ã¨èª¬æ˜ã®åˆ†ã‹ã‚Šã‚„ã™ã•
            - âœ… ä¸€è²«æ€§: ä»–ã®æ–‡æ›¸ã¨ã®æ›¸å¼ãƒ»æ§‹æˆã®çµ±ä¸€

            ### ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒã‚¤ãƒ³ãƒˆ
            - [ ] æŠ€è¡“çš„ãªæ­£ç¢ºæ€§ã®ç¢ºèª
            - [ ] èª¬æ˜ã®åˆ†ã‹ã‚Šã‚„ã™ã•
            - [ ] ã‚³ãƒ¼ãƒ‰ä¾‹ã®å‹•ä½œç¢ºèª

            ---
            *Generated by Gemini CLI on $(date +'%Y-%m-%d')*
            
          delete-branch: true
          labels: |
            documentation
            ai-generated
            enhancement
